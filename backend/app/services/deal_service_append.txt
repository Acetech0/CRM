
    @staticmethod
    async def update_stage(db: AsyncSession, tenant_id: str, deal_id: str, stage: DealStage) -> Deal:
        stmt = select(Deal).where(
            Deal.id == deal_id,
            Deal.tenant_id == tenant_id
        )
        result = await db.execute(stmt)
        deal = result.scalar_one_or_none()
        
        if not deal:
            raise HTTPException(status_code=404, detail="Deal not found")
            
        deal.stage = stage
        await db.commit()
        await db.refresh(deal)
        return deal
